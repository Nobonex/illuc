<div class="app-shell">
    <main class="content">
        <app-task-sidebar
            *ngIf="baseRepo() as repo"
            [tasks]="tasks()"
            [selectedTaskId]="taskStore.selectedTaskId()"
            [homeSelected]="isDashboardRoute()"
            [baseRepo]="repo"
            [stopLoadingIds]="stoppingTasks()"
            [discardLoadingIds]="discardingTasks()"
            (createTask)="openCreateTaskModal()"
            (selectHome)="selectHome()"
            (selectTask)="selectTask($event)"
            (stopTask)="stopTask($event)"
            (discardTask)="discardTask($event)"
        ></app-task-sidebar>

        <div class="task-host">
            <app-task-view
                *ngIf="!selectedTask()"
                class="task-view"
                [task]="null"
                [baseRepo]="baseRepo()"
                [showGettingStarted]="isGettingStartedRoute()"
                [startLoading]="false"
                [stopLoading]="false"
                [discardLoading]="false"
                [selectRepoLoading]="isSelectingRepo"
                [selectRepoError]="repoSelectionError()"
                (startTask)="startTask($event)"
                (stopTask)="stopTask($event)"
                (discardTask)="discardTask($event)"
                (selectBaseRepo)="browseForRepo()"
            ></app-task-view>

            <app-task-view
                *ngFor="let entry of mountedTasks(); trackBy: trackMountedTask"
                class="task-view task-view-layer"
                [class.is-active]="entry.taskId === selectedTaskId()"
                [task]="entry.task"
                [baseRepo]="baseRepo()"
                [showGettingStarted]="false"
                [backgroundMode]="entry.taskId !== selectedTaskId()"
                [startLoading]="isStartingTask(entry.taskId)"
                [stopLoading]="isStoppingTask(entry.taskId)"
                [discardLoading]="isDiscardingTaskFor(entry.taskId)"
                [selectRepoLoading]="isSelectingRepo"
                (startTask)="startTask($event)"
                (stopTask)="stopTask($event)"
                (discardTask)="discardTask($event)"
                (selectBaseRepo)="browseForRepo()"
            ></app-task-view>
        </div>
    </main>

    <footer class="status-bar" *ngIf="baseRepo()">
        <ng-container
            *ngIf="selectedTask() as currentTask; else statusPlaceholder"
        >
            <span class="status-meta">
                Branch: <strong>{{ currentTask.branchName }}</strong> •
                Worktree:
                <a
                    href="#"
                    class="path-link"
                    (click)="openInExplorer($event, currentTask.worktreePath)"
                    [attr.title]="currentTask.worktreePath"
                >
                    {{ currentTask.worktreePath }}
                </a>
            </span>
        </ng-container>
        <ng-template #statusPlaceholder>
            <span class="status-meta status-placeholder"
                >Select a task to see branch and worktree details.</span
            >
        </ng-template>
    </footer>

    <div class="modal-backdrop" *ngIf="showCreateModal">
        <div class="modal">
            <h3>Create Task</h3>
            <div class="modal-tabs" role="tablist" aria-label="Create task mode">
                <button
                    type="button"
                    class="modal-tab"
                    [class.active]="createTaskTab === 'create'"
                    [attr.aria-selected]="createTaskTab === 'create'"
                    (click)="setCreateTaskTab('create')"
                >
                    Create new branch
                </button>
                <button
                    type="button"
                    class="modal-tab"
                    [class.active]="createTaskTab === 'continue'"
                    [attr.aria-selected]="createTaskTab === 'continue'"
                    (click)="setCreateTaskTab('continue')"
                >
                    Continue with branch
                </button>
            </div>
            <p class="modal-subtitle" *ngIf="createTaskTab === 'create'">
                Create a new branch from a selected base branch.
            </p>
            <p class="modal-subtitle" *ngIf="createTaskTab === 'continue'">
                Create a task from an existing branch.
            </p>
            <ng-container *ngIf="createTaskTab === 'create'; else continueBranchTab">
                <label class="input-label">Branch name</label>
                <input
                    type="text"
                    [(ngModel)]="branchNameInput"
                    placeholder="e.g. feature/25323-fancy-feature-name"
                />
                <label class="input-label">Base branch</label>
                <div class="select-wrapper">
                    <select [(ngModel)]="baseBranchSelection">
                        <option
                            *ngIf="
                                baseBranchSelection &&
                                branchOptions().indexOf(baseBranchSelection) === -1
                            "
                            [value]="baseBranchSelection"
                        >
                            {{ baseBranchSelection }}
                        </option>
                        <option
                            *ngFor="let branch of branchOptions()"
                            [value]="branch"
                        >
                            {{ branch }}
                        </option>
                    </select>
                    <span class="select-arrow">⌄</span>
                </div>
            </ng-container>
            <ng-template #continueBranchTab>
                <div class="select-wrapper">
                    <select [(ngModel)]="continueBranchSelection">
                        <option
                            *ngIf="
                                continueBranchSelection &&
                                branchOptions().indexOf(continueBranchSelection) === -1
                            "
                            [value]="continueBranchSelection"
                        >
                            {{ continueBranchSelection }}
                        </option>
                        <option
                            *ngFor="let branch of branchOptions()"
                            [value]="branch"
                        >
                            {{ branch }}
                        </option>
                    </select>
                    <span class="select-arrow">⌄</span>
                </div>
            </ng-template>
            <div class="error" *ngIf="createTaskTab === 'continue' && branchOptions().length === 0">
                No existing branches found.
            </div>
            <div class="error" *ngIf="branchNameError()">
                {{ branchNameError() }}
            </div>
            <div class="modal-actions">
                <app-loading-button
                    buttonType="button"
                    buttonClass="ghost"
                    [disabled]="isCreatingTask()"
                    (action)="closeCreateTaskModal()"
                >
                    Cancel
                </app-loading-button>
                <app-loading-button
                    buttonType="button"
                    buttonClass="primary"
                    [loading]="isCreatingTask()"
                    (action)="submitNewTask()"
                >
                    Create Task
                </app-loading-button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" *ngIf="confirmDiscard() as confirm">
        <div class="modal">
            <h3>Discard task?</h3>
            <p class="modal-subtitle">
                This will remove the worktree and discard all changes for
                <strong>{{ confirm.title }}</strong>
                <span *ngIf="confirm.branch"
                    >({{ confirm.branch }})</span
                >. This action cannot be undone.
            </p>
            <p class="modal-subtitle warning" *ngIf="confirm.hasChanges">
                Uncommitted changes were detected and will be lost.
            </p>
            <div class="error" *ngIf="confirm.error">
                {{ confirm.error }}
            </div>
            <div class="modal-actions">
                <app-loading-button
                    buttonType="button"
                    buttonClass="ghost"
                    (action)="cancelDiscardTask()"
                >
                    Cancel
                </app-loading-button>
                <app-loading-button
                    buttonType="button"
                    buttonClass="primary warn"
                    (action)="confirmDiscardTask()"
                >
                    Discard
                </app-loading-button>
            </div>
        </div>
    </div>
</div>
