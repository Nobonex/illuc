<div class="diff-comment-thread" (click)="$event.stopPropagation()">
    <button
        type="button"
        class="diff-thread-collapse"
        (click)="collapseThread.emit($event)"
        aria-label="Collapse thread"
        title="Collapse thread"
    >
        <app-icon-collapse-chevrons></app-icon-collapse-chevrons>
    </button>
    <div class="diff-comment-thread-inner">
        <div *ngIf="comments.length; else noComments" class="diff-comment-list">
            <div *ngFor="let comment of comments; let index = index" class="diff-comment">
                <div class="diff-comment-meta">
                    <div class="diff-comment-meta-left">
                        <span class="diff-comment-author">
                            {{ displayNameFor(comment.author) }}
                        </span>
                        <span class="diff-comment-time">
                            {{ comment.createdAt | date: "short" }}
                        </span>
                    </div>
                    <div class="diff-comment-meta-right">
                        <div
                            *ngIf="index === 0"
                            class="select-wrapper diff-comment-status-wrap"
                        >
                            <select
                                class="diff-comment-status"
                                [attr.data-status]="threadStatus || 'active'"
                                [ngModelOptions]="{ standalone: true }"
                                [ngModel]="threadStatus || 'active'"
                                (ngModelChange)="onStatusChange($event)"
                                [disabled]="isThreadStatusUpdating"
                            >
                                <option
                                    *ngFor="let option of reviewStatusOptions"
                                    [ngValue]="option.value"
                                >
                                    {{ option.label }}
                                </option>
                            </select>
                            <span
                                class="select-arrow diff-comment-status-arrow"
                                aria-hidden="true"
                                >âŒ„</span
                            >
                        </div>
                        <button
                            type="button"
                            class="diff-comment-action"
                            (click)="startEditing(comment)"
                            aria-label="Edit comment"
                            title="Edit comment"
                            [disabled]="
                                isEditing(comment) ||
                                editingCommentIds.has(comment.id) ||
                                deletingCommentIds.has(comment.id)
                            "
                        >
                            <app-icon-pencil-edit></app-icon-pencil-edit>
                        </button>
                        <button
                            type="button"
                            class="diff-comment-action danger"
                            (click)="onDeleteComment(comment)"
                            aria-label="Delete comment"
                            title="Delete comment"
                            [disabled]="
                                deletingCommentIds.has(comment.id) ||
                                editingCommentIds.has(comment.id)
                            "
                        >
                            <app-icon-trash-bin></app-icon-trash-bin>
                        </button>
                    </div>
                </div>
                <div
                    *ngIf="isEditing(comment); else commentBody"
                    class="diff-comment-edit"
                >
                    <textarea
                        class="diff-comment-edit-input"
                        rows="3"
                        [ngModelOptions]="{ standalone: true }"
                        [ngModel]="editDraft"
                        (ngModelChange)="editDraft = $event"
                    ></textarea>
                    <div class="diff-comment-edit-actions">
                        <button
                            type="button"
                            class="diff-comment-edit-btn secondary"
                            (click)="cancelEditing()"
                            [disabled]="editingCommentIds.has(comment.id)"
                        >
                            Cancel
                        </button>
                        <button
                            type="button"
                            class="diff-comment-edit-btn"
                            (click)="onSaveEdit(comment)"
                            [disabled]="!canSaveEdit(comment)"
                        >
                            Save
                        </button>
                    </div>
                </div>
                <ng-template #commentBody>
                    <div class="diff-comment-body">
                    <div [innerHTML]="renderCommentBody(comment)"></div>
                </div>
                </ng-template>
            </div>
        </div>
        <ng-template #noComments>
            <div class="diff-comment-empty">Start a new review thread.</div>
        </ng-template>
        <form
            class="diff-comment-form"
            [class.has-draft]="draft.trim().length > 0"
            (submit)="submitComment.emit($event)"
        >
            <textarea
                class="diff-comment-input"
                rows="3"
                [ngModelOptions]="{ standalone: true }"
                [ngModel]="draft"
                (ngModelChange)="draftChange.emit($event)"
                placeholder="Write a comment.."
            ></textarea>
            <div class="diff-comment-actions">
                <button
                    type="submit"
                    class="diff-comment-submit"
                    [disabled]="!canSubmit"
                    (mousedown)="$event.preventDefault()"
                >
                    Comment
                </button>
            </div>
        </form>
    </div>
</div>
