<section class="diff-panel">
    <header class="diff-header">
        <div>
            <strong>Live Diff</strong>
            <small *ngIf="lastUpdated">
                Updated {{ lastUpdated | date: "shortTime" }}
            </small>
        </div>
        <div class="controls">
            <div class="mode-toggle" role="group" aria-label="Diff mode">
                <button
                    type="button"
                    [class.active]="diffMode === 'worktree'"
                    (click)="setDiffMode('worktree')"
                >
                    Worktree changes
                </button>
                <button
                    type="button"
                    [class.active]="diffMode === 'branch'"
                    (click)="setDiffMode('branch')"
                >
                    Branch vs {{ baseBranch || "base" }}
                </button>
            </div>
        </div>
    </header>

    <ng-container *ngIf="taskId; else noTaskSelected">
        <div *ngIf="error" class="diff-error">{{ error }}</div>

        <div
            *ngIf="!error && renderedRows.length; else noDiff"
            class="diff-content"
        >
            <aside
                class="file-list"
                *ngIf="diffPayload?.files?.length; else noFiles"
            >
                <h4>Files</h4>
                <app-file-tree
                    [nodes]="fileTree"
                    (selectFile)="scrollToFile($event)"
                ></app-file-tree>
            </aside>
            <div class="diff-body">
                <cdk-virtual-scroll-viewport
                    class="diff-viewport"
                    [itemSize]="rowHeight"
                >
                    <div
                        *cdkVirtualFor="let row of renderedRows; trackBy: trackByRow"
                        class="diff-row"
                        [class.spacer]="row.kind === 'spacer'"
                        [class.header]="row.kind === 'header'"
                        [class.thread]="row.kind === 'thread'"
                        [class.add]="row.kind === 'line' && row.line?.type === 'add'"
                        [class.del]="row.kind === 'line' && row.line?.type === 'del'"
                        [class.context]="row.kind === 'line' && row.line?.type === 'context'"
                        [class.hunk]="row.kind === 'line' && row.line?.type === 'hunk'"
                        [class.meta]="row.kind === 'line' && row.line?.type === 'meta'"
                        [class.has-comment]="row.kind === 'line' && hasComments(row)"
                        [class.thread-open]="row.kind === 'line' && isThreadOpen(row)"
                    >
                        <div
                            *ngIf="row.kind === 'header'"
                            class="diff-file-header"
                        >
                            <button
                                type="button"
                                class="diff-file-header-button"
                                [title]="row.filePath"
                                (click)="openFileInVsCode(row.filePath, $event)"
                            >
                                {{ row.filePath }}
                            </button>
                        </div>
                        <div
                            *ngIf="row.kind === 'line'"
                            class="diff-line-content"
                            [innerHTML]="row.line?.html"
                        ></div>
                        <button
                            *ngIf="row.kind === 'line' && isCommentableRow(row)"
                            type="button"
                            class="diff-comment-gutter"
                            [class.has-comments]="hasComments(row)"
                            (click)="toggleThread(row, $event)"
                        >
                            <span class="diff-comment-plus">+</span>
                            <span
                                *ngIf="commentCount(row) > 0"
                                class="diff-comment-count"
                            >
                                {{ commentCount(row) }}
                            </span>
                        </button>
                        <button
                            *ngIf="
                                row.kind === 'line' &&
                                isThreadCollapsed(row) &&
                                commentCount(row) > 0
                            "
                            type="button"
                            class="diff-thread-collapsed"
                            (click)="openCollapsedThread(row, $event)"
                            title="Expand thread"
                            aria-label="Expand thread"
                        >
                            <span class="diff-thread-collapsed-icon">â–¸</span>
                            <span class="diff-thread-collapsed-count">
                                {{ commentCount(row) }}
                            </span>
                        </button>
                        <div
                            *ngIf="row.kind === 'thread' && row.threadTarget"
                            class="diff-comment-thread"
                            (click)="$event.stopPropagation()"
                        >
                            <button
                                type="button"
                                class="diff-thread-collapse"
                                (click)="toggleThreadCollapsed(row, $event)"
                                aria-label="Collapse thread"
                                title="Collapse thread"
                            >
                                <svg
                                    class="diff-thread-collapse-glyph"
                                    viewBox="0 0 12 16"
                                    aria-hidden="true"
                                >
                                    <polyline
                                        points="3,2 6,6 9,2"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2.5"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                    <polyline
                                        points="3,14 6,10 9,14"
                                        fill="none"
                                        stroke="currentColor"
                                        stroke-width="2.5"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                    />
                                </svg>
                            </button>
                            <div
                                class="diff-comment-thread-inner"
                            >
                                <div
                                    *ngIf="
                                        commentsFor(row).length;
                                        else noComments
                                    "
                                    class="diff-comment-list"
                                >
                                    <div
                                        *ngFor="let comment of commentsFor(row)"
                                        class="diff-comment"
                                    >
                                        <div class="diff-comment-meta">
                                            <span
                                                class="diff-comment-author"
                                            >
                                                {{
                                                    displayNameFor(
                                                        comment.author
                                                    )
                                                }}
                                            </span>
                                            <span class="diff-comment-time">
                                                {{
                                                    comment.createdAt
                                                        | date: "short"
                                                }}
                                            </span>
                                        </div>
                                        <div class="diff-comment-body">
                                            <div
                                                [innerHTML]="
                                                    renderCommentBody(comment)
                                                "
                                            ></div>
                                        </div>
                                    </div>
                                </div>
                                <ng-template #noComments>
                                    <div class="diff-comment-empty">
                                        Start a new review thread.
                                    </div>
                                </ng-template>
                                <form
                                    class="diff-comment-form"
                                    [class.has-draft]="
                                        getDraft(row).trim().length > 0
                                    "
                                    (submit)="submitComment(row, $event)"
                                >
                                    <textarea
                                        class="diff-comment-input"
                                        rows="3"
                                        [ngModelOptions]="{
                                            standalone: true
                                        }"
                                        [ngModel]="getDraft(row)"
                                        (ngModelChange)="setDraft(row, $event)"
                                        placeholder="Write a comment.."
                                    ></textarea>
                                    <div class="diff-comment-actions">
                                    <button
                                        type="submit"
                                        class="diff-comment-submit"
                                        [disabled]="!canSubmitComment(row)"
                                        (mousedown)="$event.preventDefault()"
                                    >
                                        Comment
                                    </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        <div *ngIf="row.kind === 'spacer'" class="diff-spacer"></div>
                    </div>
                </cdk-virtual-scroll-viewport>
            </div>
        </div>

        <ng-template #noFiles>
            <p class="diff-empty">No changed files.</p>
        </ng-template>
    </ng-container>

    <ng-template #noTaskSelected>
        <p class="diff-empty">Select a task to see its diff.</p>
    </ng-template>

    <ng-template #noDiff>
        <div class="diff-empty diff-loading" *ngIf="isLoading">
            <span class="diff-spinner" aria-hidden="true"></span>
        </div>
        <p class="diff-empty" *ngIf="!isLoading && hasLoaded">
            No changed files.
        </p>
        <p class="diff-empty" *ngIf="!isLoading && !hasLoaded">
            Nothing to show yet.
        </p>
    </ng-template>

    <ng-template #noComments>
        <div class="diff-comment-empty">
            Start a new review thread.
        </div>
    </ng-template>
</section>
