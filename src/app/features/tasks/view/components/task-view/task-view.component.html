<ng-container *ngIf="task as current; else emptyState">
    <section
        class="task-detail"
        [class.shell-collapsed]="!isShellTerminalOpen"
        #taskDetail
    >
        <header class="task-header">
            <div class="task-title" *ngIf="titleParts() as parts">
                <h2>
                    <span *ngIf="parts.taskId" class="task-pill"
                        >#{{ parts.taskId }}</span
                    >
                    <span>{{ parts.label }}</span>
                </h2>
            </div>
            <div class="header-actions">
                <div class="workspace-actions">
                    <app-open-vscode-button
                        [path]="current.worktreePath"
                    ></app-open-vscode-button>
                    <app-open-terminal-button
                        [path]="current.worktreePath"
                    ></app-open-terminal-button>
                </div>
                <span class="status-pill" [attr.data-status]="current.status">
                    {{ statusLabel() }}
                </span>
                <app-task-action-button
                    type="commit"
                    [disabled]="!current"
                    (action)="openCommitModal()"
                ></app-task-action-button>
                <app-task-action-button
                    type="push"
                    [disabled]="!current"
                    (action)="openPushModal()"
                ></app-task-action-button>
                <app-task-action-button
                    type="discard"
                    [disabled]="!current"
                    [loading]="discardLoading"
                    (action)="onDiscard()"
                ></app-task-action-button>
            </div>
        </header>

        <div class="split-panels">
            <div
                class="terminal-column"
                [class.active]="activePane === 'terminal'"
                (mouseenter)="setActivePane('terminal')"
                (focusin)="setActivePane('terminal')"
            >
                <section class="terminal-session-panel">
                    <header class="terminal-toolbar">
                        <div class="terminal-toolbar-title">
                            <strong>Chat Terminal</strong>
                            <app-task-action-button
                                *ngIf="isRunning()"
                                type="stop"
                                [disabled]="!isRunning()"
                                [loading]="stopLoading"
                                (action)="onStop()"
                            ></app-task-action-button>
                        </div>
                    </header>
                    <div class="terminal-session-body">
                        <app-task-terminal
                            *ngIf="isRunning(); else idleTerminal"
                            [taskId]="current.taskId"
                            [mode]="'agent'"
                            [agentKind]="current.agentKind"
                            [showToolbar]="false"
                        ></app-task-terminal>
                        <ng-template #idleTerminal>
                            <div class="terminal-idle-placeholder">
                                <div class="terminal-idle-content">
                                    <p class="terminal-idle-eyebrow">
                                        Agent Session
                                    </p>
                                    <h3>Ready to start this task</h3>
                                    <p class="terminal-idle-copy">
                                        Launch an agent to open the terminal
                                        session and begin working on this
                                        branch.
                                    </p>
                                    <app-start-agent-dropdown
                                        [disabled]="!canStart()"
                                        [loading]="startLoading"
                                        (start)="startWith($event)"
                                    ></app-start-agent-dropdown>
                                </div>
                            </div>
                        </ng-template>
                    </div>
                </section>
            </div>
            <div
                *ngIf="!backgroundMode"
                class="diff-column"
                [class.active]="activePane === 'diff'"
                (mouseenter)="setActivePane('diff')"
                (focusin)="setActivePane('diff')"
            >
                <app-task-diff
                    [taskId]="current.taskId"
                    [baseBranch]="current.baseBranch"
                    [worktreePath]="current.worktreePath"
                ></app-task-diff>
            </div>
        </div>
        <div
            class="worktree-terminal-dock"
            #shellDock
            [class.is-collapsed]="!isShellTerminalOpen"
            [class.is-resizing]="isShellResizing"
            [style.height.px]="isShellTerminalOpen ? shellTerminalHeight : 34"
        >
            <div class="shell-terminal-frame">
                <div
                    class="shell-terminal-header"
                    role="separator"
                    aria-orientation="horizontal"
                    [class.is-collapsed]="!isShellTerminalOpen"
                    (mousedown)="onShellHeaderMouseDown($event)"
                    (click)="onShellHeaderClick()"
                >
                    <div class="shell-title"><strong>Shell</strong></div>
                    <button
                        type="button"
                        class="shell-toggle"
                        [attr.aria-pressed]="isShellTerminalOpen"
                        [attr.aria-label]="
                            isShellTerminalOpen
                                ? 'Collapse shell terminal'
                                : 'Expand shell terminal'
                        "
                        (click)="
                            $event.stopPropagation(); toggleShellTerminal()
                        "
                    >
                        {{ isShellTerminalOpen ? "▾" : "▴" }}
                    </button>
                </div>
                <app-task-terminal
                    *ngIf="isShellTerminalOpen"
                    #shellTerminal
                    [taskId]="current.taskId"
                    [mode]="'worktree'"
                    [showToolbar]="false"
                    [suspendBackendResize]="isShellResizing"
                    [suspendFit]="isShellResizing"
                ></app-task-terminal>
            </div>
        </div>
    </section>
</ng-container>

<div class="modal-backdrop" *ngIf="showCommitModal">
    <div class="modal">
        <h3>Commit changes</h3>
        <p class="modal-subtitle">Write a commit message for this task.</p>
        <label class="input-label">Commit message</label>
        <input
            type="text"
            [(ngModel)]="commitMessage"
            placeholder="e.g. Add task summary view"
        />
        <label class="checkbox">
            <input type="checkbox" [(ngModel)]="commitStageAll" />
            Stage all changes
        </label>
        <div class="error" *ngIf="commitError">{{ commitError }}</div>
        <div class="modal-actions">
            <app-loading-button
                buttonType="button"
                buttonClass="ghost"
                [disabled]="isCommitting"
                (action)="closeCommitModal()"
            >
                Cancel
            </app-loading-button>
            <app-loading-button
                buttonType="button"
                buttonClass="primary"
                [loading]="isCommitting"
                (action)="submitCommit()"
            >
                Commit
            </app-loading-button>
        </div>
    </div>
</div>

<div class="modal-backdrop" *ngIf="showPushModal">
    <div class="modal">
        <h3>Push changes</h3>
        <p class="modal-subtitle">Push this task branch to a remote.</p>
        <label class="input-label">Remote</label>
        <input type="text" [(ngModel)]="pushRemote" placeholder="origin" />
        <label class="input-label">Branch</label>
        <input type="text" [(ngModel)]="pushBranch" />
        <label class="checkbox">
            <input type="checkbox" [(ngModel)]="pushSetUpstream" />
            Set upstream
        </label>
        <div class="error" *ngIf="pushError">{{ pushError }}</div>
        <div class="modal-actions">
            <app-loading-button
                buttonType="button"
                buttonClass="ghost"
                [disabled]="isPushing"
                (action)="closePushModal()"
            >
                Cancel
            </app-loading-button>
            <app-loading-button
                buttonType="button"
                buttonClass="primary"
                [loading]="isPushing"
                (action)="submitPush()"
            >
                Push
            </app-loading-button>
        </div>
    </div>
</div>

<ng-template #emptyState>
    <app-task-home-dashboard
        *ngIf="!showGettingStarted || !baseRepo; else gettingStarted"
        [baseRepo]="baseRepo"
        [selectRepoLoading]="selectRepoLoading"
        (selectBaseRepo)="onSelectBaseRepo()"
    ></app-task-home-dashboard>
    <ng-template #gettingStarted>
        <app-task-getting-started
            [baseRepo]="baseRepo"
        ></app-task-getting-started>
    </ng-template>
</ng-template>
